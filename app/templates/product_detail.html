{% extends "base.html" %}
{% block content %}

<div class="container mt-5">
  <div class="row">
    <div class="col-md-5">
      <div class="card shadow-sm">
        <img src="{{ url_for('static', filename='images/' + product.image_url) }}" class="card-img-top" alt="{{ product.name }}">
      </div>
    </div>

    <div class="col-md-7">
      <div class="card shadow-sm p-4">
        <h2 class="mb-3">{{ product.name }}</h2>
        <p class="text-muted">{{ product.description }}</p>

        <form method="POST" action="{{ url_for('main.add_to_cart', product_id=product.id) }}">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

          {% if product.ingredients %}
          <div class="mb-4">
            <label class="form-label fw-bold">Добавьте ингредиенты:</label>
            {% for ingredient in product.ingredients %}
              <div class="d-flex align-items-center justify-content-between border rounded p-2 mb-2">
                <div>
                  <strong>{{ ingredient.name }}</strong> (+${{ '%.2f' % ingredient.price }})
                </div>
                <div class="d-flex align-items-center">
                  <button type="button" class="btn btn-outline-secondary btn-sm me-1 minus-btn" data-id="{{ ingredient.id }}">-</button>
                  <input type="number"
                         name="ingredient_{{ ingredient.id }}"
                         id="ingredient_{{ ingredient.id }}"
                         class="form-control text-center"
                         value="0" min="0" style="width: 60px;"
                         data-price="{{ ingredient.price }}">
                  <button type="button" class="btn btn-outline-secondary btn-sm ms-1 plus-btn" data-id="{{ ingredient.id }}">+</button>
                </div>
              </div>
            {% endfor %}
          </div>
          {% endif %}

          <div class="mb-3">
            <label for="quantity" class="form-label fw-bold">Количество пицц:</label>
            <input type="number" name="quantity" id="quantity" class="form-control w-25" value="1" min="1">
          </div>

          <div class="mb-3">
            <h4>Итоговая цена: $<span id="total-price">{{ '%.2f' % product.price }}</span></h4>
          </div>

          <button type="submit" class="btn btn-success btn-lg">Добавить в корзину</button>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
  const basePrice = parseFloat({{ product.price }});
  const quantityInput = document.getElementById('quantity');
  const totalPriceEl = document.getElementById('total-price');

  function updateTotal() {
    let ingredientsTotal = 0;
    {% for ingredient in product.ingredients %}
    const count{{ ingredient.id }} = parseInt(document.getElementById('ingredient_{{ ingredient.id }}').value) || 0;
    const price{{ ingredient.id }} = parseFloat({{ ingredient.price }});
    ingredientsTotal += count{{ ingredient.id }} * price{{ ingredient.id }};
    {% endfor %}

    const pizzaQuantity = parseInt(quantityInput.value) || 1;
    const total = (basePrice + ingredientsTotal) * pizzaQuantity;
    totalPriceEl.textContent = total.toFixed(2);
  }

  document.querySelectorAll('.plus-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const id = btn.dataset.id;
      const input = document.getElementById('ingredient_' + id);
      input.value = parseInt(input.value) + 1;
      updateTotal();
    });
  });

  document.querySelectorAll('.minus-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const id = btn.dataset.id;
      const input = document.getElementById('ingredient_' + id);
      input.value = Math.max(0, parseInt(input.value) - 1);
      updateTotal();
    });
  });

  document.querySelectorAll('input[type="number"]').forEach(input => {
    input.addEventListener('input', updateTotal);
  });
</script>

{% endblock %}
